<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Koneiden Varausjärjestelmä (Paikallinen Demo)</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 40px;
        background: #f7f7f7;
    }
    h2 {
        margin-bottom: 20px;
        margin-top: 0;
        text-align: center;
    }

    .container {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 600px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        margin: 20px auto;
    }

    select, input {
        padding: 8px;
        margin: 5px 0;
        width: 100%;
        font-size: 16px;
    }
    button {
        padding: 10px;
        margin-top: 10px;
        width: 100%;
        font-size: 16px;
        background: #0078ff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        min-height: 45px;
    }
    button:hover {
        background: #005fcc;
    }
    .machine-list {
        margin-top: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 10px;
    }
    .machine-box {
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        color: white;
        font-weight: bold;
        cursor: pointer;
    }
    .free {
        background: #28a745;
    }
    .reserved {
        background: #dc3545;
    }

    .filter-box {
        margin-bottom: 20px;
    }

    /* Responsiivisuus */
    @media (max-width: 600px) {
        body { margin: 10px; }
        .container { padding: 15px; margin-bottom: 20px; box-shadow: none; border-radius: 6px; }
        select, input { font-size: 18px; padding: 10px; }
        button { font-size: 18px; padding: 12px; }
        .machine-list { grid-template-columns: repeat(1,1fr); }
        .machine-box { font-size: 16px; padding: 15px; }
    }
    @media (max-width: 900px) {
        .machine-list { grid-template-columns: repeat(2,1fr); }
    }
</style>
</head>
<body>

<h2>Koneiden varausjärjestelmä (Paikallinen Demo, 1–99)</h2>

<div class="container">

    <h3>Varaa kone</h3>
    <label>Valitse vapaa kone:</label>
    <select id="freeMachines"></select>

    <label>Anna käyttäjänumero:</label>
    <input type="number" id="reserveUser" placeholder="Esim. 123">

    <button onclick="reserveMachine()">Varaa kone</button>

    <hr style="margin: 30px 0;">

    <h3>Vapauta kone</h3>
    <label>Syötä koneen numero:</label>
    <input type="number" id="releaseMachine" placeholder="1–99">

    <label>Anna käyttäjänumero:</label>
    <input type="number" id="releaseUser" placeholder="Esim. 123">

    <button style="background:#ff4444;" onclick="releaseMachine()">Vapauta kone</button>

</div>

<div class="container">
    <h3>Koneiden tila</h3>
    <div class="filter-box">
        <label>Suodata:</label>
        <select id="filter" onchange="renderMachines()">
            <option value="all">Kaikki</option>
            <option value="free">Vapaat</option>
            <option value="reserved">Varatut</option>
        </select>
    </div>

    <div class="machine-list" id="machineList"></div>
</div>

<script>
const MAX = 99;
const allMachines = Array.from({ length: MAX }, (_, i) => i + 1);
let dbData = {}; // Paikallinen "tietokanta"

const freeSelect = document.getElementById("freeMachines");
const machineList = document.getElementById("machineList");

// Päivitä vapaat koneet valikkoon
function updateFreeSelect() {
    const previousValue = freeSelect.value; // muista nykyinen valinta
    freeSelect.innerHTML = "";

    const free = allMachines.filter(n => 
        !dbData[n] || dbData[n].status === "vapaa"
    );

    free.forEach(n => {
        let opt = document.createElement("option");
        opt.value = n;
        opt.textContent = `Kone ${n}`;
        freeSelect.appendChild(opt);
    });

    if (free.length === 0) {
        let opt = document.createElement("option");
        opt.textContent = "Ei vapaita koneita";
        freeSelect.appendChild(opt);
    } else if (free.includes(Number(previousValue))) {
        freeSelect.value = previousValue; // palauta valinta, jos se on edelleen vapaa
    } else {
        freeSelect.value = free[0]; // muuten ensimmäinen vapaa
    }
}


// Renderöi koneet
function renderMachines() {
    const filter = document.getElementById("filter").value;
    machineList.innerHTML = "";

    allMachines.forEach(n => {
        const m = dbData[n] || { status: "vapaa", user: "" };
        const isFree = m.status === "vapaa";

        if (filter === "free" && !isFree) return;
        if (filter === "reserved" && isFree) return;

        const box = document.createElement("div");
        box.className = "machine-box " + (isFree ? "free" : "reserved");
        box.textContent = isFree ? `Kone ${n} — VAPAA` : `Kone ${n} — VARATTU (${m.user})`;

        // Klikkaus valitsee koneen varaukseen
        box.onclick = () => {
            if (isFree) {
                freeSelect.value = n;
                window.scrollTo({ top: 0, behavior: "smooth" });
            }
        };

        machineList.appendChild(box);
    });
}

// Varaus
function reserveMachine() {
    const machine = freeSelect.value;
    const user = document.getElementById("reserveUser").value;

    if (!machine || machine === "Ei vapaita koneita") return alert("Ei vapaita koneita.");
    if (!user) return alert("Anna käyttäjänumero!");

    dbData[machine] = {
        status: "varattu",
        user: user,
        timestamp: Date.now()
    };

    updateFreeSelect();
    renderMachines();
    document.getElementById("reserveUser").value = "";
}

// Vapautus
function releaseMachine() {
    const machine = document.getElementById("releaseMachine").value;
    const user = document.getElementById("releaseUser").value;

    if (!machine) return alert("Anna koneen numero!");
    if (!user) return alert("Anna käyttäjänumero!");

    dbData[machine] = {
        status: "vapaa",
        user: "",
        timestamp: null
    };

    updateFreeSelect();
    renderMachines();
    document.getElementById("releaseMachine").value = "";
    document.getElementById("releaseUser").value = "";
}

// Automaattinen timeout (24h, testissä nopeutettavissa)
function checkTimeouts() {
    const now = Date.now();
    const timeoutMs = 24*60*60*1000; // 24h
    allMachines.forEach(n => {
        const m = dbData[n];
        if (!m) return;
        if (m.status === "varattu" && m.timestamp) {
            if (now - m.timestamp > timeoutMs) {
                dbData[n] = { status: "vapaa", user: "", timestamp: null };
            }
        }
    });
    updateFreeSelect();
    renderMachines();
}

// Päivitys 1 sekunnin välein (automaattinen timeout ja UI)
setInterval(checkTimeouts, 1000);

// Ensimmäinen renderöinti
updateFreeSelect();
renderMachines();
</script>

</body>
</html>
